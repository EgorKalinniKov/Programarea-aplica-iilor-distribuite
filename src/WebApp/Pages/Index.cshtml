@page
@model WebApp.Pages.IndexModel
@{
    ViewData["Title"] = "Учёт расходов";
}

<div class="container mt-4">
    <h1 class="mb-4">Учёт домашних расходов</h1>

    <!-- Навигация -->
    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button">
                Расходы
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button">
                Категории
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button">
                Статистика
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button">
                Импорт/Экспорт
            </button>
        </li>
    </ul>

    <!-- Содержимое вкладок -->
    <div class="tab-content" id="mainTabsContent">
        <!-- Вкладка Расходы -->
        <div class="tab-pane fade show active" id="expenses" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-12">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                        Добавить расход
                    </button>
                    <button class="btn btn-secondary" onclick="loadExpenses()">
                        Обновить
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped" id="expensesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Категория</th>
                            <th>Сумма</th>
                            <th>Дата</th>
                            <th>Описание</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <tr>
                            <td colspan="6" class="text-center">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Категории -->
        <div class="tab-pane fade" id="categories" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-12">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        Добавить категорию
                    </button>
                    <button class="btn btn-secondary" onclick="loadCategories()">
                        Обновить
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped" id="categoriesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <tr>
                            <td colspan="3" class="text-center">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Статистика -->
        <div class="tab-pane fade" id="statistics" role="tabpanel">
            <h3>Фильтр по периоду</h3>
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Начальная дата</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Конечная дата</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary d-block" onclick="loadStatisticsWithPeriod()">
                        Применить фильтр
                    </button>
                </div>
            </div>

            <h3>Общая статистика</h3>
            <div id="summaryStats" class="mb-4">
                <p>Загрузка...</p>
            </div>

            <h3>Статистика по дням</h3>
            <div id="dailyStats" class="mb-4">
                <p>Загрузка...</p>
            </div>

            <h3>Статистика по категориям</h3>
            <div id="categoryStats">
                <p>Загрузка...</p>
            </div>
        </div>

        <!-- Вкладка Импорт/Экспорт -->
        <div class="tab-pane fade" id="import-export" role="tabpanel">
            <h3>Экспорт данных</h3>
            <button class="btn btn-success mb-4" onclick="exportCSV()">
                Экспортировать в CSV
            </button>

            <h3>Импорт данных</h3>
            <div class="mb-3">
                <label for="csvFile" class="form-label">Выберите CSV файл</label>
                <input class="form-control" type="file" id="csvFile" accept=".csv">
            </div>
            <button class="btn btn-primary" onclick="importCSV()">
                Импортировать
            </button>
            <div id="importResult" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления расхода -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить расход</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="expenseCategory" class="form-label">Категория</label>
                        <select class="form-select" id="expenseCategory" required>
                            <option value="">Выберите категорию...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseDate" class="form-label">Дата</label>
                        <input type="date" class="form-control" id="expenseDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="expenseDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления категории -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить категорию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Название категории</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Добавить</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script src="~/js/app.js"></script>
    <script src="~/js/statistics-websocket.js"></script>
    <script>
        document.getElementById('statistics-tab').addEventListener('click', function() {
            initWebSocket();
            loadStatisticsWithPeriod();
        });
    </script>
}

